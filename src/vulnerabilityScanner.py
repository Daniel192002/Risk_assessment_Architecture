from gvm.connections import UnixSocketConnection
from gvm.protocols.gmp import Gmp
from gvm.transforms import EtreeCheckCommandTransform
from lxml import etree
import databaseManager
import time

class VulnerabilityScanner:
    def __init__(self):
        # Usamos conexión por socket UNIX
        self.connection = UnixSocketConnection(path='/run/gvmd/gvmd.sock')
        self.transform = EtreeCheckCommandTransform()
    
    def scan_devices_from_db(self):
        with Gmp(connection=self.connection, transform=self.transform) as gmp:
            gmp.authenticate('admin', 'c5dcf636-a85d-4895-8430-dae5413b1c84')
            print("[+] Autenticación exitosa con GVM.")

            db = databaseManager.DatabaseManager(user="root", password="tfg2025", host="127.0.0.1")
            devices = db.get_devices()

            for mac, ipv4, ipv6 in devices:
                if ipv4 and mac:
                    print(f"[+] Escaneando {ipv4} ({mac})...")
                    self.scan_ip(gmp, ipv4)

            db.close()
    
    def scan_ip(self, gmp, ip):
        target_name = f"Scan-{ip}"
        task_name = f"Task-{ip}"
        
        target_id = None
        existing_targets = gmp.get_targets()
        for target in existing_targets.xpath("target"):
            name = target.find("name").text
            if name == target_name:
                target_id = target.get("id")
                print(f"[DEBUG] Objetivo existente: {target_name} (ID: {target_id})")
                break
        if not target_id:
            port_list_id = gmp.get_port_lists().xpath("port_list[name='All IANA assigned TCP and UDP']/@id")[0]
            target_response = gmp.create_target(
                name = target_name,
                hosts = [ip],
                port_list_id = port_list_id
            )
            target_id = target_response.get("id")
            print(f"[DEBUG] Objetivo creado: {target_name} (ID: {target_id})")
        
        config_id = None
        configs = gmp.get_scan_configs()
        print(f"[DEBUG] XML bruto de scan_configs:")
        print(etree.tostring(configs, pretty_print=True).decode())
        for config in configs.xpath(".//config"):
            name = config.find("name").text
            print(f"[DEBUG] Config Name: {name} | ID: {config.get('id')}")
            if "Full and fast" in name:
                config_id = config.get("id")
                break
        if not config_id:
            raise RuntimeError("No se encontró la configuración de escaneo 'Full and fast'.")
        
        scanner_id = None
        scanners = gmp.get_scanners()
        for scanner in scanners.xpath("scanner"):
            name = scanner.find("name").text
            if "OpenVAS Default" in name:
                scanner_id = scanner.get("id")
                print(f"[DEBUG] Scanner Name: {name} | ID: {scanner_id}")
                break
        if not scanner_id:
            raise RuntimeError("No se encontró un escáner válido ('OpenVAS Default').")
        
        
        task_id = None
        existing_tasks = gmp.get_tasks()
        for task in existing_tasks.xpath("task"):
            name = task.find("name").text
            if name == task_name:
                task_id = task.get("id")
                print(f"[DEBUG] Tarea existente: {task_name} (ID: {task_id})")
                break
        if not task_id:
            response = gmp.create_task(task_name, config_id, target_id, scanner_id )
            task_id = response.get('id')
            print(f"[DEBUG] Tarea creada: {task_name} (ID: {task_id})")
        
        gmp.start_task(task_id)
        print(f"[✓] Escaneo iniciado para {ip} (task ID: {task_id})")
        
        print("[...] Esperando a que termine la tarea...")
        while True:
            task_info = gmp.get_task(task_id=task_id)
            print(f"[DEBUG] XML bruto de scan_configs:")
            print(etree.tostring(task_info, pretty_print=True).decode())
            status_element = task_info.find("status")
            if status_element is None:
                print("[ERROR] No se pudo obtener el estado de la tarea.")
                return
            status = status_element.text
            print(f"[DEBUG] Estado actual: {status}")
            if status == "Done":
                print("[✓] Escaneo finalizado.")
                break
            time.sleep(10)
        
        last_report_elem = task_info.find(".//last_report/report")
        if last_report_elem is None:
            print("[!] No se encontró el último reporte.")
            return
        
        report_id = last_report_elem.get("id")
        print(f"[DEBUG] Reporte ID: {report_id}")
        
        report = gmp.get_report(report_id=report_id, details=True)
        
        print(f"[+] Resultados del escaneo para {ip}:")
        for result in report.xpath(".//result"):
            name = result.findtext("name")
            severity = result.findtext("severity")
            host = result.findtext("host")
            port = result.findtext("port")
            print(f" - Host: {host}, Puerto: {port}, Vulnerabilidad: {name}, Severidad: {severity}")
        